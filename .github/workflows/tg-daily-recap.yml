name: Daily Dev Recap

on:
  schedule:
    - cron: "0 1 * * *"   # 08:00 Cambodia time
  workflow_dispatch:

jobs:
  recap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        id: stats
        with:
          script: |
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              since: new Date(Date.now() - 86400000).toISOString()
            })

            const authors = {}
            commits.forEach(c => {
              const name = c.commit.author.name
              authors[name] = (authors[name] || 0) + 1
            })

            const top = Object.entries(authors).sort((a,b)=>b[1]-a[1])[0]

            core.setOutput("commits", commits.length)
            core.setOutput("top", top ? `${top[0]} (${top[1]})` : "No commits")

      - run: |
          COMMITS=${{ steps.stats.outputs.commits }}
          TIMESTAMP=$(date -u +"%Y-%m-%d")
          if [ "$COMMITS" -eq 0 ]; then
            VIBE="ğŸŒ™ Rest day vibes"
          elif [ "$COMMITS" -lt 5 ]; then
            VIBE="ğŸ”¥ Steady progress"
          elif [ "$COMMITS" -lt 10 ]; then
            VIBE="âš¡ High velocity"
          else
            VIBE="ğŸš€ Absolute beast mode"
          fi
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
          -d chat_id=${{ secrets.TG_CHAT_ID }} \
          -d message_thread_id=$TG_TOPIC_ID \
          -d parse_mode=Markdown \
          -d text=$'ğŸ“Š *DAILY DEV RECAP*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“… *Date:* '"$TIMESTAMP"$'\n\nğŸ“ˆ *Today\'s Stats:*\nâ€¢ Total Commits: *${{ steps.stats.outputs.commits }}*\nâ€¢ MVP Developer: *${{ steps.stats.outputs.top }}*\nâ€¢ Team Vibe: '"$VIBE"$'\n\nğŸ’¡ *Insights:*\n'$([ "$COMMITS" -gt 0 ] && echo "âœ¨ Code shipped, bugs squashed, features launched" || echo "ğŸŒ™ Sometimes rest is the best productivity")$'\n\nğŸ”— [View Repository](https://github.com/${{ github.repository }})\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ§  Another day, another deploy\nğŸ’ª Rest up, tomorrow we build more ğŸ”‹'


env:
  TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
  TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
  TG_TOPIC_ID: ${{ secrets.TG_TOPIC_ID }}
