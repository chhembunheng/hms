name: Daily Dev Recap

on:
  schedule:
    - cron: "0 1 * * *"   # 08:00 Cambodia time
  workflow_dispatch:

jobs:
  recap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        id: stats
        with:
          script: |
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              since: new Date(Date.now() - 86400000).toISOString()
            })

            const authors = {}
            commits.forEach(c => {
              const name = c.commit.author.name
              authors[name] = (authors[name] || 0) + 1
            })

            const top = Object.entries(authors).sort((a,b)=>b[1]-a[1])[0]

            core.setOutput("commits", commits.length)
            core.setOutput("top", top ? `${top[0]} (${top[1]})` : "No commits")

      - run: |
          COMMITS=${{ steps.stats.outputs.commits }}
          TIMESTAMP=$(TZ='Asia/Phnom_Penh' date +"%B %d, %Y")
          if [ "$COMMITS" -eq 0 ]; then
            VIBE="ğŸŒ™ Rest day energy"
            MOOD="Sometimes the best code is no code. Recharge complete ğŸ”‹"
          elif [ "$COMMITS" -lt 5 ]; then
            VIBE="ğŸ”¥ Steady grind"
            MOOD="Small wins add up. Consistency hits different ğŸ’¯"
          elif [ "$COMMITS" -lt 10 ]; then
            VIBE="âš¡ High output mode"
            MOOD="The code was flowing today. Respectful hustle ğŸš€"
          else
            VIBE="ğŸ’¥ Absolute demon mode"
            MOOD="Team went crazy today. This is what peak performance looks like ğŸ‘‘"
          fi
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
          -d chat_id=${{ secrets.TG_CHAT_ID }} \
          -d message_thread_id=$TG_TOPIC_ID \
          -d parse_mode=Markdown \
          -d text=$'ğŸ“Š *Daily Dev Recap*\nâ•™â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•œ\nğŸ“… '"$TIMESTAMP"$'\n\nğŸ“Š *Today\'s stats:*\nâ€¢ Commits shipped: *${{ steps.stats.outputs.commits }}*\nâ€¢ MVP of the day: *${{ steps.stats.outputs.top }}*\nâ€¢ Team vibe: '"$VIBE"$'\n\nğŸ’­ _'"$MOOD"$'_\n\nğŸ”— [Repo link](https://github.com/${{ github.repository }})\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸŒŸ GG team. Run it back tomorrow ğŸ”'


env:
  TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
  TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
  TG_TOPIC_ID: ${{ secrets.TG_TOPIC_ID }}
