name: Daily Dev Recap

on:
  schedule:
    - cron: "0 1 * * *"   # 08:00 Cambodia time
  workflow_dispatch:

jobs:
  recap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        id: stats
        with:
          script: |
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              since: new Date(Date.now() - 86400000).toISOString()
            })

            const authors = {}
            commits.forEach(c => {
              const name = c.commit.author.name
              authors[name] = (authors[name] || 0) + 1
            })

            const top = Object.entries(authors).sort((a,b)=>b[1]-a[1])[0]

            core.setOutput("commits", commits.length)
            core.setOutput("top", top ? `${top[0]} (${top[1]})` : "No commits")

      - run: |
          COMMITS=${{ steps.stats.outputs.commits }}
          TIMESTAMP=$(TZ='Asia/Phnom_Penh' date +"%B %d, %Y")
          if [ "$COMMITS" -eq 0 ]; then
            VIBE="rest day energy ğŸŒ™"
          elif [ "$COMMITS" -lt 5 ]; then
            VIBE="steady grind ğŸ”¥"
          elif [ "$COMMITS" -lt 10 ]; then
            VIBE="high output âš¡"
          else
            VIBE="demon mode ğŸ’¥"
          fi
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
          -d chat_id=${{ secrets.TG_CHAT_ID }} \
          -d message_thread_id=$TG_TOPIC_ID \
          -d parse_mode=Markdown \
          -d text=$'ğŸ“Š *Daily recap*\n\nğŸ“… '"$TIMESTAMP"$'\n\nğŸš€ ${{ steps.stats.outputs.commits }} commits\nğŸ‘‘ ${{ steps.stats.outputs.top }}\nğŸ’­ '"$VIBE"$'\n\n[Repo](https://github.com/${{ github.repository }})\n\ngg team, run it back tomorrow ğŸ”'


env:
  TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
  TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
  TG_TOPIC_ID: ${{ secrets.TG_TOPIC_ID }}
